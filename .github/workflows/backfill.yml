name: Backfill Notion

on:
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: backfill-notion
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
      NOTION_PARENT_PAGE_ID: ${{ secrets.NOTION_PARENT_PAGE_ID }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Backfill existing outputs to Notion
        run: node src/backfill_notion.js

      - name: Persist state to 'state' branch
        if: always()
        env:
          USE_PAT: ${{ secrets.GH_PAT }}
          REPO: ${{ github.repository }}
        run: |
          set -e
          if [ ! -f data/state.json ]; then
            echo "No state.json to persist; skipping."
            exit 0
          fi
          cp data/state.json /tmp/state.json
          git config user.name "actions-state-bot"
          git config user.email "actions@users.noreply.github.com"
          if [ -n "$USE_PAT" ]; then
            git remote set-url origin https://x-access-token:$USE_PAT@github.com/$REPO
          fi
          git fetch origin || true
          if git show-ref --verify --quiet refs/remotes/origin/state; then
            git checkout -B state origin/state
          else
            git checkout -b state
          fi
          mkdir -p data
          cp /tmp/state.json data/state.json
          git add -f data/state.json
          if git diff --cached --quiet; then
            echo "No state changes to commit."
          else
            git commit -m "chore(state): backfill update [skip ci]"
            git push origin state
          fi

      - name: Upload outputs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backfill-${{ github.run_id }}
          path: |
            output
            data/state.json
          if-no-files-found: warn

